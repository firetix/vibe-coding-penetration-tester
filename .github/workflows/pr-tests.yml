name: PR Tests

on:
  pull_request:
  workflow_dispatch:
    inputs:
      preview_url:
        description: "Optional Vercel preview URL to run deployed smoke tests against"
        required: false
        type: string

permissions:
  contents: read
  pull-requests: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browser
        run: |
          playwright install chromium

      - name: Run unit tests
        run: |
          python -m pytest tests/unit -q

      - name: Run critical API E2E
        run: |
          python -m pytest tests/e2e/api -m e2e_api_critical -q

      - name: Run frontend smoke E2E
        run: |
          python -m pytest tests/e2e/frontend -m e2e_frontend_smoke -q

  vercel-preview-e2e:
    name: Vercel Preview E2E
    needs: test
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.preview_url != '')
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      VERCEL_BYPASS_TOKEN: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browser
        run: |
          playwright install chromium

      - name: Resolve Vercel preview URL
        id: resolve_preview
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.preview_url }}" ]; then
            echo "preview_url=${{ github.event.inputs.preview_url }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_NUMBER="${{ github.event.pull_request.number }}"
          if [ -z "$PR_NUMBER" ]; then
            echo "No pull request number found and no manual preview_url input was provided."
            exit 1
          fi

          for attempt in $(seq 1 30); do
            COMMENTS_JSON="$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments --paginate || true)"
            PREVIEW_URL="$(printf '%s' "$COMMENTS_JSON" \
              | jq -r 'map(select(.user.login=="vercel[bot]")) | last | .body // ""' \
              | grep -Eo 'https://[A-Za-z0-9.-]+\.vercel\.app' \
              | head -n1)"

            if [ -z "$PREVIEW_URL" ]; then
              CHECKS_JSON="$(gh pr checks "$PR_NUMBER" --json name,link --jq '.[] | select(.name=="Vercel") | .link' 2>/dev/null || true)"
              PREVIEW_URL="$(printf '%s' "$CHECKS_JSON" \
                | grep -Eo 'https://[A-Za-z0-9.-]+\.vercel\.app' \
                | head -n1)"
            fi

            if [ -n "$PREVIEW_URL" ]; then
              echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"
              echo "Resolved preview URL: $PREVIEW_URL"
              exit 0
            fi

            echo "Waiting for Vercel preview comment (attempt $attempt/30)..."
            sleep 20
          done

          echo "No Vercel preview URL resolved after retries; skipping deployed preview E2E."
          echo "preview_url=" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Wait for preview readiness
        if: steps.resolve_preview.outputs.preview_url != ''
        shell: bash
        run: |
          PREVIEW_URL="${{ steps.resolve_preview.outputs.preview_url }}"
          for attempt in $(seq 1 30); do
            if [ -n "$VERCEL_BYPASS_TOKEN" ]; then
              STATUS_CODE="$(curl -s -o /dev/null -w "%{http_code}" \
                -H "x-vercel-protection-bypass: $VERCEL_BYPASS_TOKEN" \
                -H "x-vercel-set-bypass-cookie: true" \
                "$PREVIEW_URL" || true)"
            else
              STATUS_CODE="$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL" || true)"
            fi
            if [ "$STATUS_CODE" -ge 200 ] && [ "$STATUS_CODE" -lt 500 ]; then
              echo "Preview is reachable with status $STATUS_CODE"
              exit 0
            fi
            echo "Preview not ready yet (status $STATUS_CODE), attempt $attempt/30..."
            sleep 10
          done
          echo "Preview URL did not become reachable in time."
          exit 1

      - name: Run deployed Vercel E2E smoke
        if: steps.resolve_preview.outputs.preview_url != ''
        env:
          VPT_BASE_URL: ${{ steps.resolve_preview.outputs.preview_url }}
          VERCEL_BYPASS_TOKEN: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        run: |
          python -m pytest tests/e2e/vercel -m e2e_vercel_preview -q

      - name: Skip deployed preview E2E when URL unavailable
        if: steps.resolve_preview.outputs.preview_url == ''
        run: |
          echo "Skipping deployed Vercel preview E2E because no preview URL was available."
